<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة النقل المدرسي - الإصدار الشامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#f3f4f6',
                        accent: '#667eea',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    },
                    fontFamily: {
                        arabic: ['Tajawal', 'Arial', 'sans-serif']
                    },
                    screens: {
                        'xs': '475px',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Tajawal', Arial, sans-serif;
        }
        
        /* Professional Animations */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideOutLeft {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-50px); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Gradient Backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-primary {
            background: linear-gradient(135deg, #5D5CDE, #667eea);
        }

        .gradient-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .gradient-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        /* Professional Cards */
        .card-professional {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .card-professional::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .card-professional:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.15);
        }
        
        /* Professional Buttons */
        .btn-professional {
            background: linear-gradient(135deg, #5D5CDE, #667eea);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .btn-professional:hover {
            background: linear-gradient(135deg, #4c4bcd, #5a6fd8);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(93, 92, 222, 0.3);
        }

        .btn-professional:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }

        /* Action Buttons */
        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            min-width: 44px;
            min-height: 44px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
        }

        .btn-edit {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-view {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* Section Header */
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .section-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .section-header-content {
            position: relative;
            z-index: 1;
        }

        /* Back Button */
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        /* Professional Table */
        .table-professional {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .table-header {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-bottom: 2px solid #e2e8f0;
        }

        .table-row {
            transition: all 0.3s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .table-row:hover {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            transform: translateX(4px);
        }

        /* Professional Form */
        .form-professional {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .input-professional {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
        }

        .input-professional:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        /* Fixed Sidebar Styles */
        .sidebar-container {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 256px;
            background: white;
            box-shadow: -4px 0 6px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-container.open {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            .sidebar-container {
                position: fixed;
                transform: translateX(0);
                z-index: 10;
            }
            
            .main-content {
                margin-right: 256px;
            }
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Dark Mode Support */
        .dark {
            background-color: #0f172a;
            color: white;
        }

        .dark .card-professional {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-color: #475569;
        }

        .dark .table-professional {
            background: #1e293b;
            border-color: #475569;
        }

        .dark .table-header {
            background: linear-gradient(135deg, #334155, #475569);
            border-bottom-color: #475569;
        }

        .dark .table-row:hover {
            background: linear-gradient(135deg, #334155, #475569);
        }

        .dark .input-professional {
            background: #374151;
            border-color: #4b5563;
            color: white;
        }

        .dark .input-professional:focus {
            border-color: #667eea;
        }

        .dark .sidebar-container {
            background: #1e293b;
            border-left: 1px solid #475569;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            max-width: 400px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .notification-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .notification-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .notification-info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        /* Section Transitions */
        .section {
            animation: slideInRight 0.4s ease-out;
        }

        .section.hide {
            animation: slideOutLeft 0.3s ease-in;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .card-professional {
                padding: 16px;
            }
            
            .section-header {
                padding: 16px;
            }
            
            .btn-action {
                min-width: 40px;
                min-height: 40px;
                padding: 8px;
            }

            .main-content {
                margin-right: 0;
            }
        }

        /* Quick action cards */
        .quick-action-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .quick-action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .dark .quick-action-card {
            background: #334155;
        }

        /* Search container */
        .search-container {
            position: relative;
        }

        .search-container::before {
            content: '\f002';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .search-input {
            padding-left: 44px;
        }

        /* Search Results */
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .search-result-item:hover {
            background: #f3f4f6;
            border-color: #667eea;
            transform: translateX(4px);
        }

        .dark .search-result-item:hover {
            background: #374151;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-present {
            background: #d1fae5;
            color: #065f46;
        }

        .status-absent {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-active {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-expired {
            background: #fef3c7;
            color: #92400e;
        }

        /* Form labels */
        .form-label {
            display: block;
            text-sm;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .dark .form-label {
            color: #d1d5db;
        }

        .form-group {
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-600 dark:text-gray-300">جاري المعالجة...</p>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notificationsContainer"></div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay lg:hidden"></div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center gradient-bg p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md" style="animation: bounceIn 0.6s ease-out;">
            <div class="text-center mb-8">
                <div class="mx-auto h-16 w-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-lg">
                    <i class="fas fa-bus text-primary text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">نظام إدارة النقل المدرسي</h1>
                <p class="text-gray-600 dark:text-gray-300 mt-2">النظام الشامل والمتكامل</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">اسم المستخدم</label>
                    <input type="text" id="username" class="input-professional" placeholder="أدخل اسم المستخدم" required>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">كلمة المرور</label>
                    <input type="password" id="password" class="input-professional" placeholder="أدخل كلمة المرور" required>
                </div>
                
                <button type="submit" id="loginBtn" class="w-full btn-professional text-lg">
                    <span id="loginText">تسجيل الدخول</span>
                    <span id="loginLoading" class="loading-spinner hidden"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Navigation Header -->
        <nav class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30">
            <div class="px-6">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <!-- Mobile menu button -->
                        <button id="mobileMenuBtn" class="lg:hidden p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-bars text-lg"></i>
                        </button>
                        
                        <div class="h-10 w-10 gradient-primary rounded-full flex items-center justify-center shadow-lg">
                            <i class="fas fa-bus text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">نظام إدارة النقل المدرسي</h1>
                            <p class="text-xs text-gray-500 dark:text-gray-400">النظام الشامل والمتكامل</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <!-- Notifications Bell -->
                        <div class="relative">
                            <button id="notificationBtn" class="relative p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-bell"></i>
                                <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                            </button>
                        </div>
                        
                        <span id="usernameDisplay" class="text-gray-600 dark:text-gray-300 hidden sm:block font-medium">مرحباً، Admin</span>
                        <button id="logoutBtn" class="text-red-600 hover:text-red-800 transition-colors p-2 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="hidden sm:inline mr-2">خروج</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar-container dark:bg-gray-800">
            <!-- Mobile sidebar header -->
            <div class="lg:hidden flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">القائمة الرئيسية</h2>
                <button id="closeSidebar" class="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <nav class="p-4 mt-4">
                <div class="space-y-2">
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="dashboard">
                        <i class="fas fa-tachometer-alt ml-3 group-hover:animate-pulse"></i>
                        <span>لوحة التحكم</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="students">
                        <i class="fas fa-user-graduate ml-3 group-hover:animate-pulse"></i>
                        <span>الطلاب</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="supervisors">
                        <i class="fas fa-user-tie ml-3 group-hover:animate-pulse"></i>
                        <span>تصاريح المشرفات</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="drivers">
                        <i class="fas fa-id-card ml-3 group-hover:animate-pulse"></i>
                        <span>تصاريح السائقين</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="buses">
                        <i class="fas fa-bus ml-3 group-hover:animate-pulse"></i>
                        <span>تصاريح الحافلات</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="fuel">
                        <i class="fas fa-gas-pump ml-3 group-hover:animate-pulse"></i>
                        <span>الديزل</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="maintenance">
                        <i class="fas fa-tools ml-3 group-hover:animate-pulse"></i>
                        <span>الصيانة</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="attendance">
                        <i class="fas fa-clock ml-3 group-hover:animate-pulse"></i>
                        <span>الحضور والانصراف</span>
                    </button>
                    <button class="nav-item w-full text-right px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white rounded-lg transition-all duration-300 group" data-section="resignations">
                        <i class="fas fa-user-times ml-3 group-hover:animate-pulse"></i>
                        <span>الاستقالات والإجازات</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content p-6">
            <!-- Expiry Warnings -->
            <div id="expiryWarnings"></div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">لوحة التحكم الرئيسية</h2>
                                <p class="text-lg opacity-90">مرحباً بك في النظام الشامل لإدارة النقل المدرسي</p>
                            </div>
                            <div class="hidden lg:block">
                                <i class="fas fa-tachometer-alt text-6xl opacity-20"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Search Bar -->
                <div class="card-professional mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-search text-primary text-xl ml-3"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">البحث السريع في النظام</h3>
                    </div>
                    <div class="search-container mb-4">
                        <input type="text" id="globalSearch" placeholder="البحث في جميع الأقسام..." class="input-professional search-input" oninput="performGlobalSearch()" autocomplete="off">
                    </div>
                    <div id="searchResults" class="hidden">
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">نتائج البحث:</h4>
                            <div id="searchResultsList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card-professional" style="animation: fadeInUp 0.5s ease-out;">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full gradient-primary">
                                <i class="fas fa-user-graduate text-white text-xl"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-semibold text-gray-600 dark:text-gray-300">إجمالي الطلاب</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="totalStudents">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-professional" style="animation: fadeInUp 0.5s ease-out; animation-delay: 0.1s;">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full gradient-success">
                                <i class="fas fa-bus text-white text-xl"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-semibold text-gray-600 dark:text-gray-300">عدد الحافلات</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="totalBuses">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-professional" style="animation: fadeInUp 0.5s ease-out; animation-delay: 0.2s;">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full gradient-warning">
                                <i class="fas fa-id-card text-white text-xl"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-semibold text-gray-600 dark:text-gray-300">عدد السائقين</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="totalDrivers">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-professional" style="animation: fadeInUp 0.5s ease-out; animation-delay: 0.3s;">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full gradient-danger">
                                <i class="fas fa-user-tie text-white text-xl"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-semibold text-gray-600 dark:text-gray-300">عدد المشرفات</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="totalSupervisors">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card-professional mb-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">الإجراءات السريعة</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="quick-action-card" onclick="showSection('students'); setTimeout(() => openStudentForm(), 300);">
                            <div class="gradient-primary p-4 rounded-full inline-block mb-4">
                                <i class="fas fa-user-plus text-white text-2xl"></i>
                            </div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">إضافة طالب</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">إضافة طالب جديد للنظام</p>
                        </div>
                        
                        <div class="quick-action-card" onclick="showSection('drivers'); setTimeout(() => openDriverForm(), 300);">
                            <div class="gradient-success p-4 rounded-full inline-block mb-4">
                                <i class="fas fa-id-card-alt text-white text-2xl"></i>
                            </div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">إضافة سائق</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">إضافة سائق جديد للنظام</p>
                        </div>
                        
                        <div class="quick-action-card" onclick="showSection('supervisors'); setTimeout(() => openSupervisorForm(), 300);">
                            <div class="gradient-warning p-4 rounded-full inline-block mb-4">
                                <i class="fas fa-user-tie text-white text-2xl"></i>
                            </div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">إضافة مشرفة</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">إضافة مشرفة جديدة للنظام</p>
                        </div>
                        
                        <div class="quick-action-card" onclick="showSection('buses'); setTimeout(() => openBusForm(), 300);">
                            <div class="gradient-danger p-4 rounded-full inline-block mb-4">
                                <i class="fas fa-bus text-white text-2xl"></i>
                            </div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">إضافة حافلة</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">إضافة حافلة جديدة للنظام</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Summary -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card-professional">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">إحصائيات الشهر الحالي</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">طلاب جدد</span>
                                <span class="font-bold text-primary" id="newStudents">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">استهلاك الديزل</span>
                                <span class="font-bold text-warning" id="fuelConsumption">0 درهم</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">عمليات الصيانة</span>
                                <span class="font-bold text-danger" id="maintenanceCount">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-professional">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">التنبيهات والإشعارات</h3>
                        <div id="alertsList" class="space-y-2">
                            <div class="flex items-center p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <i class="fas fa-check-circle text-green-600 ml-2"></i>
                                <span class="text-sm text-green-800 dark:text-green-200">لا توجد تنبيهات جديدة</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="students" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-user-graduate text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">إدارة الطلاب</h2>
                        <p class="text-lg opacity-90">إدارة شاملة لبيانات جميع الطلاب</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="studentsImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('students', this)">
                        </div>
                        <button onclick="exportToExcel('students')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addStudentBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>إضافة طالب جديد</span>
                    </button>
                </div>
                
                <div class="card-professional">
                    <div class="mb-6">
                        <div class="search-container">
                            <input type="text" id="studentSearch" placeholder="البحث عن طالب..." class="input-professional search-input" oninput="filterTable('students')">
                        </div>
                    </div>
                    
                    <div class="table-professional overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">رقم الاسيس</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">اسم الطالب</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">الصف</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden md:table-cell">المنطقة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">المشرفة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">السائق</th>
                                    <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 dark:text-gray-300">العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Supervisors Section -->
            <div id="supervisors" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-user-tie text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">تصاريح المشرفات</h2>
                        <p class="text-lg opacity-90">إدارة تصاريح وبيانات المشرفات</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="supervisorsImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('supervisors', this)">
                        </div>
                        <button onclick="exportToExcel('supervisors')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addSupervisorBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>إضافة مشرفة جديدة</span>
                    </button>
                </div>
                
                <div class="card-professional">
                    <div class="mb-6">
                        <div class="search-container">
                            <input type="text" id="supervisorSearch" placeholder="البحث عن مشرفة..." class="input-professional search-input" oninput="filterTable('supervisors')">
                        </div>
                    </div>
                    
                    <div class="table-professional overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">رقم التصريح</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">اسم المشرفة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">الهاتف</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden md:table-cell">تاريخ انتهاء التصريح</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">المنطقة</th>
                                    <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 dark:text-gray-300">العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="supervisorsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Drivers Section -->
            <div id="drivers" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-id-card text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">تصاريح السائقين</h2>
                        <p class="text-lg opacity-90">إدارة تصاريح وبيانات السائقين</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="driversImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('drivers', this)">
                        </div>
                        <button onclick="exportToExcel('drivers')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addDriverBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>إضافة سائق جديد</span>
                    </button>
                </div>
                
                <div class="card-professional">
                    <div class="mb-6">
                        <div class="search-container">
                            <input type="text" id="driverSearch" placeholder="البحث عن سائق..." class="input-professional search-input" oninput="filterTable('drivers')">
                        </div>
                    </div>
                    
                    <div class="table-professional overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">رقم التصريح</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">اسم السائق</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">الهاتف</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden md:table-cell">المنطقة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">تاريخ انتهاء التصريح</th>
                                    <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 dark:text-gray-300">العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="driversTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Buses Section -->
            <div id="buses" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-bus text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">تصاريح الحافلات</h2>
                        <p class="text-lg opacity-90">إدارة تصاريح وبيانات الحافلات</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="busesImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('buses', this)">
                        </div>
                        <button onclick="exportToExcel('buses')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addBusBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>إضافة حافلة جديدة</span>
                    </button>
                </div>
                
                <div class="card-professional">
                    <div class="mb-6">
                        <div class="search-container">
                            <input type="text" id="busSearch" placeholder="البحث عن حافلة..." class="input-professional search-input" oninput="filterTable('buses')">
                        </div>
                    </div>
                    
                    <div class="table-professional overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">رقم الحافلة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">اسم الشركة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">النوع</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden md:table-cell">رقم DOT</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">تاريخ انتهاء DOT</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">تاريخ انتهاء الملكية</th>
                                    <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 dark:text-gray-300">العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="busesTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Fuel Section -->
            <div id="fuel" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-gas-pump text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">إدارة الديزل</h2>
                        <p class="text-lg opacity-90">إدارة شاملة لاستهلاك الديزل</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="fuelImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('fuel', this)">
                        </div>
                        <button onclick="exportToExcel('fuel')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addFuelBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>إضافة تعبئة جديدة</span>
                    </button>
                </div>

                <!-- Top Fuel Consumers -->
                <div class="card-professional mb-6">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">الحافلات الأكثر استهلاكاً للديزل</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="topFuelConsumers">
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-500 dark:text-gray-400">لا توجد بيانات</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-professional">
                    <div class="mb-6">
                        <div class="search-container">
                            <input type="text" id="fuelSearch" placeholder="البحث في سجلات الديزل..." class="input-professional search-input" oninput="filterTable('fuel')">
                        </div>
                    </div>
                    
                    <div class="table-professional overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">رقم الحافلة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">اسم السائق</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">تاريخ التعبئة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">المبلغ</th>
                                    <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 dark:text-gray-300">العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="fuelTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Maintenance Section -->
            <div id="maintenance" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-tools text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">إدارة الصيانة</h2>
                        <p class="text-lg opacity-90">إدارة شاملة لعمليات الصيانة</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="maintenanceImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('maintenance', this)">
                        </div>
                        <button onclick="exportToExcel('maintenance')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addMaintenanceBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>إضافة صيانة جديدة</span>
                    </button>
                </div>
                
                <div class="card-professional">
                    <div class="mb-6">
                        <div class="search-container">
                            <input type="text" id="maintenanceSearch" placeholder="البحث في سجلات الصيانة..." class="input-professional search-input" oninput="filterTable('maintenance')">
                        </div>
                    </div>
                    
                    <div class="table-professional overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">نوع الصيانة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">تاريخ الصيانة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">رقم الحافلة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden md:table-cell">التكلفة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">الوصف</th>
                                    <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 dark:text-gray-300">العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendance" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-clock text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">الحضور والانصراف</h2>
                        <p class="text-lg opacity-90">إدارة حضور السائقين والمشرفات</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="attendanceImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('attendance', this)">
                        </div>
                        <button onclick="exportToExcel('attendance')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addAttendanceBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>تسجيل حضور</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card-professional">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">حضور السائقين اليوم</h3>
                        <div class="table-professional overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="table-header">
                                    <tr>
                                        <th class="px-4 py-3 text-right text-sm font-bold text-gray-700 dark:text-gray-300">اسم السائق</th>
                                        <th class="px-4 py-3 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">الوقت</th>
                                        <th class="px-4 py-3 text-center text-sm font-bold text-gray-700 dark:text-gray-300">الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="driversAttendanceBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card-professional">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">حضور المشرفات اليوم</h3>
                        <div class="table-professional overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="table-header">
                                    <tr>
                                        <th class="px-4 py-3 text-right text-sm font-bold text-gray-700 dark:text-gray-300">اسم المشرفة</th>
                                        <th class="px-4 py-3 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">الوقت</th>
                                        <th class="px-4 py-3 text-center text-sm font-bold text-gray-700 dark:text-gray-300">الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="supervisorsAttendanceBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resignations Section -->
            <div id="resignations" class="section hidden">
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="flex items-center justify-between mb-4">
                            <button class="back-btn" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-right"></i>
                                <span>العودة</span>
                            </button>
                            <div class="hidden lg:block">
                                <i class="fas fa-user-times text-6xl opacity-20"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">الاستقالات والإجازات</h2>
                        <p class="text-lg opacity-90">إدارة الاستقالات والإجازات</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <button class="gradient-success text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-upload ml-2"></i>استيراد Excel
                            </button>
                            <input type="file" id="resignationsImport" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importExcel('resignations', this)">
                        </div>
                        <button onclick="exportToExcel('resignations')" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-download ml-2"></i>تصدير Excel
                        </button>
                    </div>
                    <button id="addResignationBtn" class="btn-professional">
                        <i class="fas fa-plus"></i>
                        <span>إضافة جديد</span>
                    </button>
                </div>
                
                <div class="card-professional">
                    <div class="mb-6">
                        <div class="search-container">
                            <input type="text" id="resignationSearch" placeholder="البحث في الاستقالات والإجازات..." class="input-professional search-input" oninput="filterTable('resignations')">
                        </div>
                    </div>
                    
                    <div class="table-professional overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">الاسم</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden sm:table-cell">النوع</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300">الحالة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden md:table-cell">التاريخ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 dark:text-gray-300 hidden lg:table-cell">السبب</th>
                                    <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 dark:text-gray-300">العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="resignationsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Enhanced Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700" style="animation: bounceIn 0.6s ease-out;">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-900 dark:text-white">عنوان النموذج</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div id="modalContent" class="form-professional">
                    <!-- Modal content will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDWX7eDpIDcAnyLRfRtJorCLJ4T74d3me4",
            authDomain: "transportation-c1152.firebaseapp.com",
            databaseURL: "https://transportation-c1152-default-rtdb.firebaseio.com",
            projectId: "transportation-c1152",
            storageBucket: "transportation-c1152.firebasestorage.app",
            messagingSenderId: "632274574767",
            appId: "1:632274574767:web:a8dda8b750743e13ae635a",
            measurementId: "G-QJ18MLDMHF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Database helper functions
        class DatabaseManager {
            static async saveData(collection, data) {
                try {
                    if (data.id) {
                        await db.collection(collection).doc(data.id).set(data);
                        return data.id;
                    } else {
                        const docRef = await db.collection(collection).add(data);
                        return docRef.id;
                    }
                } catch (error) {
                    console.error(`Error saving to ${collection}:`, error);
                    throw error;
                }
            }

            static async getAllData(collection) {
                try {
                    const snapshot = await db.collection(collection).get();
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    return data;
                } catch (error) {
                    console.error(`Error getting ${collection}:`, error);
                    return [];
                }
            }

            static async deleteData(collection, id) {
                try {
                    await db.collection(collection).doc(id).delete();
                } catch (error) {
                    console.error(`Error deleting from ${collection}:`, error);
                    throw error;
                }
            }

            static async updateData(collection, id, data) {
                try {
                    await db.collection(collection).doc(id).update(data);
                } catch (error) {
                    console.error(`Error updating ${collection}:`, error);
                    throw error;
                }
            }
        }

        // Session management
        class SessionManager {
            static setLoggedIn(username) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('username', username);
                sessionStorage.setItem('loginTime', new Date().getTime());
            }

            static isLoggedIn() {
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                const loginTime = sessionStorage.getItem('loginTime');
                
                if (!isLoggedIn || !loginTime) return false;
                
                // Check if session is still valid (24 hours)
                const currentTime = new Date().getTime();
                const sessionDuration = 24 * 60 * 60 * 1000; // 24 hours
                
                if (currentTime - parseInt(loginTime) > sessionDuration) {
                    this.logout();
                    return false;
                }
                
                return true;
            }

            static logout() {
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('username');
                sessionStorage.removeItem('loginTime');
            }

            static getUsername() {
                return sessionStorage.getItem('username') || 'Admin';
            }
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let currentSection = 'dashboard';
        let editingId = null;
        let sidebarOpen = false;
        let isSubmitting = false;

        // Application State
        const appState = {
            students: [],
            supervisors: [],
            drivers: [],
            buses: [],
            fuel: [],
            maintenance: [],
            attendance: [],
            resignations: []
        };

        // Enhanced Notification System
        class NotificationManager {
            static show(message, type = 'info', duration = 5000) {
                const container = document.getElementById('notificationsContainer');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-${this.getIcon(type)} ml-3 text-lg"></i>
                            <span class="font-medium">${message}</span>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 p-1 rounded transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(notification);
                
                // Show notification with animation
                setTimeout(() => notification.classList.add('show'), 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }

            static getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }
        }

        // Global Search Functionality
        function performGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            if (searchTerm.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const results = [];
            
            // Search in students
            appState.students.forEach(student => {
                if (student.name && student.name.toLowerCase().includes(searchTerm) ||
                    student.aysisNumber && student.aysisNumber.toLowerCase().includes(searchTerm) ||
                    student.grade && student.grade.toLowerCase().includes(searchTerm) ||
                    student.area && student.area.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'students',
                        title: student.name,
                        subtitle: `طالب - ${student.grade} - ${student.area}`,
                        icon: 'fa-user-graduate',
                        action: () => { showSection('students'); setTimeout(() => filterTable('students', student.name), 300); }
                    });
                }
            });
            
            // Search in supervisors
            appState.supervisors.forEach(supervisor => {
                if (supervisor.name && supervisor.name.toLowerCase().includes(searchTerm) ||
                    supervisor.permitNumber && supervisor.permitNumber.toLowerCase().includes(searchTerm) ||
                    supervisor.area && supervisor.area.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'supervisors',
                        title: supervisor.name,
                        subtitle: `مشرفة - ${supervisor.permitNumber}`,
                        icon: 'fa-user-tie',
                        action: () => { showSection('supervisors'); setTimeout(() => filterTable('supervisors', supervisor.name), 300); }
                    });
                }
            });
            
            // Search in drivers
            appState.drivers.forEach(driver => {
                if (driver.name && driver.name.toLowerCase().includes(searchTerm) ||
                    driver.permitNumber && driver.permitNumber.toLowerCase().includes(searchTerm) ||
                    driver.area && driver.area.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'drivers',
                        title: driver.name,
                        subtitle: `سائق - ${driver.permitNumber}`,
                        icon: 'fa-id-card',
                        action: () => { showSection('drivers'); setTimeout(() => filterTable('drivers', driver.name), 300); }
                    });
                }
            });
            
            // Search in buses
            appState.buses.forEach(bus => {
                if (bus.number && bus.number.toLowerCase().includes(searchTerm) ||
                    bus.company && bus.company.toLowerCase().includes(searchTerm) ||
                    bus.type && bus.type.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'buses',
                        title: `حافلة ${bus.number}`,
                        subtitle: `${bus.company} - ${bus.type}`,
                        icon: 'fa-bus',
                        action: () => { showSection('buses'); setTimeout(() => filterTable('buses', bus.number), 300); }
                    });
                }
            });
            
            // Display results
            searchResultsList.innerHTML = '';
            
            if (results.length === 0) {
                searchResultsList.innerHTML = `
                    <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p class="text-sm">لا توجد نتائج للبحث "${searchTerm}"</p>
                    </div>
                `;
            } else {
                results.slice(0, 10).forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'search-result-item';
                    resultDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="p-2 rounded-lg bg-primary bg-opacity-10 ml-3">
                                <i class="fas ${result.icon} text-primary"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-900 dark:text-white">${result.title}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${result.subtitle}</div>
                            </div>
                        </div>
                        <i class="fas fa-arrow-left text-gray-400"></i>
                    `;
                    resultDiv.addEventListener('click', () => {
                        result.action();
                        document.getElementById('globalSearch').value = '';
                        searchResults.classList.add('hidden');
                    });
                    searchResultsList.appendChild(resultDiv);
                });
                
                if (results.length > 10) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'text-center py-2 text-gray-500 dark:text-gray-400 text-sm';
                    moreDiv.textContent = `وجد ${results.length - 10} نتيجة إضافية...`;
                    searchResultsList.appendChild(moreDiv);
                }
            }
            
            searchResults.classList.remove('hidden');
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check if user is already logged in
            if (SessionManager.isLoggedIn()) {
                showMainApp();
            } else {
                showLoginPage();
            }
            
            setupEventListeners();
            setupResponsiveHandlers();
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('usernameDisplay').textContent = `مرحباً، ${SessionManager.getUsername()}`;
            loadInitialData();
            showSection('dashboard');
        }

        function showLoginPage() {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Mobile menu toggle
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            
            // Sidebar overlay
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    showSection(section);
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            });
            
            // Modal
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            // Add buttons
            document.getElementById('addStudentBtn').addEventListener('click', () => openStudentForm());
            document.getElementById('addSupervisorBtn').addEventListener('click', () => openSupervisorForm());
            document.getElementById('addDriverBtn').addEventListener('click', () => openDriverForm());
            document.getElementById('addBusBtn').addEventListener('click', () => openBusForm());
            document.getElementById('addFuelBtn').addEventListener('click', () => openFuelForm());
            document.getElementById('addMaintenanceBtn').addEventListener('click', () => openMaintenanceForm());
            document.getElementById('addAttendanceBtn').addEventListener('click', () => openAttendanceForm());
            document.getElementById('addResignationBtn').addEventListener('click', () => openResignationForm());
        }

        function setupResponsiveHandlers() {
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) {
                    closeSidebar();
                }
            });
            
            // Click outside global search to close
            document.addEventListener('click', function(e) {
                const globalSearch = document.getElementById('globalSearch');
                const searchResults = document.getElementById('searchResults');
                
                if (!globalSearch.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('flex');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebarOpen) {
                closeSidebar();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
                sidebarOpen = true;
                document.body.style.overflow = 'hidden';
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            sidebarOpen = false;
            document.body.style.overflow = '';
        }

        // Enhanced section transition with animation
        function showSection(sectionName) {
            // Hide current section with animation
            const currentSectionElement = document.querySelector('.section:not(.hidden)');
            if (currentSectionElement && currentSectionElement.id !== sectionName) {
                currentSectionElement.classList.add('hide');
                setTimeout(() => {
                    currentSectionElement.classList.add('hidden');
                    currentSectionElement.classList.remove('hide');
                }, 300);
            }

            // Show new section with animation
            setTimeout(() => {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    
                    // Remove animation class after animation completes
                    setTimeout(() => {
                        targetSection.classList.remove('section-transition');
                    }, 400);
                }
                
                // Update navigation
                updateNavigation(sectionName);
                
                currentSection = sectionName;
                loadSectionData(sectionName);
            }, currentSectionElement && currentSectionElement.id !== sectionName ? 300 : 0);
        }

        function updateNavigation(sectionName) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-primary', 'text-white');
                item.classList.add('text-gray-700', 'dark:text-gray-300');
            });
            
            const activeNav = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeNav) {
                activeNav.classList.add('bg-primary', 'text-white');
                activeNav.classList.remove('text-gray-700', 'dark:text-gray-300');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginLoading = document.getElementById('loginLoading');

            if (!username || !password) {
                NotificationManager.show('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }
            
            if (username === 'admin' && password === '606486') {
                loginBtn.disabled = true;
                loginText.classList.add('hidden');
                loginLoading.classList.remove('hidden');
                
                try {
                    setTimeout(() => {
                        SessionManager.setLoggedIn(username);
                        showMainApp();
                        NotificationManager.show('مرحباً بك في النظام الشامل لإدارة النقل المدرسي', 'success');
                    }, 1500);
                } catch (error) {
                    console.error('Login error:', error);
                    NotificationManager.show('حدث خطأ أثناء تسجيل الدخول', 'error');
                    loginBtn.disabled = false;
                    loginText.classList.remove('hidden');
                    loginLoading.classList.add('hidden');
                }
            } else {
                NotificationManager.show('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
                
                // Shake the form
                const form = document.getElementById('loginForm');
                form.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => form.style.animation = '', 500);
            }
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3 space-x-reverse">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">إلغاء</button>
                        <button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded" onclick="this.closest('.fixed').remove(); (${onConfirm})()">تأكيد</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function handleLogout() {
            showConfirmDialog('هل أنت متأكد من تسجيل الخروج؟', function() {
                SessionManager.logout();
                showLoginPage();
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginText').classList.remove('hidden');
                document.getElementById('loginLoading').classList.add('hidden');
                document.getElementById('loginBtn').disabled = false;
                closeSidebar();
                NotificationManager.show('تم تسجيل الخروج بنجاح', 'info');
            });
        }

        async function loadInitialData() {
            showLoading();
            try {
                // Load all data from Firebase
                await Promise.all([
                    loadDataFromFirebase('students'),
                    loadDataFromFirebase('supervisors'),
                    loadDataFromFirebase('drivers'),
                    loadDataFromFirebase('buses'),
                    loadDataFromFirebase('fuel'),
                    loadDataFromFirebase('maintenance'),
                    loadDataFromFirebase('attendance'),
                    loadDataFromFirebase('resignations')
                ]);
                
                updateDashboardStats();
                NotificationManager.show('تم تحميل النظام بنجاح', 'success');
            } catch (error) {
                console.error('Error loading initial data:', error);
                NotificationManager.show('حدث خطأ أثناء تحميل البيانات', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadDataFromFirebase(collection) {
            try {
                const data = await DatabaseManager.getAllData(collection);
                appState[collection] = data;
            } catch (error) {
                console.error(`Error loading ${collection}:`, error);
                appState[collection] = [];
            }
        }

        function loadSectionData(section) {
            try {
                switch(section) {
                    case 'dashboard':
                        updateDashboardStats();
                        updateDashboardSummary();
                        break;
                    case 'students':
                        renderStudentsTable();
                        break;
                    case 'supervisors':
                        renderSupervisorsTable();
                        break;
                    case 'drivers':
                        renderDriversTable();
                        break;
                    case 'buses':
                        renderBusesTable();
                        break;
                    case 'fuel':
                        renderFuelTable();
                        updateTopFuelConsumers();
                        break;
                    case 'maintenance':
                        renderMaintenanceTable();
                        break;
                    case 'attendance':
                        renderAttendanceTable();
                        break;
                    case 'resignations':
                        renderResignationsTable();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${section} data:`, error);
                NotificationManager.show(`حدث خطأ أثناء تحميل بيانات ${section}`, 'error');
            }
        }

        function updateDashboardStats() {
            document.getElementById('totalStudents').textContent = appState.students.length;
            document.getElementById('totalBuses').textContent = appState.buses.length;
            document.getElementById('totalDrivers').textContent = appState.drivers.length;
            document.getElementById('totalSupervisors').textContent = appState.supervisors.length;
        }

        function updateDashboardSummary() {
            // Update monthly statistics
            const currentMonth = new Date().getMonth();
            const newStudentsCount = appState.students.filter(student => {
                // Simulate new students this month
                return Math.random() > 0.8;
            }).length;
            
            const totalFuelCost = appState.fuel.reduce((sum, fuel) => sum + parseFloat(fuel.amount || 0), 0);
            const maintenanceCount = appState.maintenance.length;
            
            document.getElementById('newStudents').textContent = newStudentsCount;
            document.getElementById('fuelConsumption').textContent = totalFuelCost.toFixed(2) + ' درهم';
            document.getElementById('maintenanceCount').textContent = maintenanceCount;
            
            // Update alerts
            updateAlertsList();
        }

        function updateAlertsList() {
            const alertsList = document.getElementById('alertsList');
            const alerts = [];
            
            // Check for expiring permits
            const today = new Date();
            const warningDays = 30;
            
            appState.drivers.forEach(driver => {
                if (driver.expiryDate) {
                    const expiryDate = new Date(driver.expiryDate);
                    const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                    if (daysLeft <= warningDays && daysLeft >= 0) {
                        alerts.push(`تصريح السائق ${driver.name} ينتهي خلال ${daysLeft} يوم`);
                    }
                }
            });
            
            appState.supervisors.forEach(supervisor => {
                if (supervisor.expiryDate) {
                    const expiryDate = new Date(supervisor.expiryDate);
                    const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                    if (daysLeft <= warningDays && daysLeft >= 0) {
                        alerts.push(`تصريح المشرفة ${supervisor.name} ينتهي خلال ${daysLeft} يوم`);
                    }
                }
            });
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="flex items-center p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
                        <i class="fas fa-check-circle text-green-600 ml-2"></i>
                        <span class="text-sm text-green-800 dark:text-green-200">لا توجد تنبيهات جديدة</span>
                    </div>
                `;
            } else {
                alertsList.innerHTML = alerts.map(alert => `
                    <div class="flex items-center p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg mb-2">
                        <i class="fas fa-exclamation-triangle text-yellow-600 ml-2"></i>
                        <span class="text-sm text-yellow-800 dark:text-yellow-200">${alert}</span>
                    </div>
                `).join('');
            }
        }

        // Enhanced Filter Table Function
        function filterTable(section, searchTerm = null) {
            const searchInput = document.getElementById(section + 'Search');
            const query = searchTerm || (searchInput ? searchInput.value.toLowerCase().trim() : '');
            const tbody = document.getElementById(section + 'TableBody');
            
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase().replace(/\s+/g, ' ');
                const isVisible = !query || text.includes(query);
                
                if (isVisible) {
                    row.style.display = '';
                    visibleCount++;
                    // Add highlight effect for search results
                    if (query && query.length > 0) {
                        row.style.backgroundColor = 'rgba(93, 92, 222, 0.05)';
                        row.style.borderLeft = '3px solid #5D5CDE';
                    } else {
                        row.style.backgroundColor = '';
                        row.style.borderLeft = '';
                    }
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update search input if called programmatically
            if (searchTerm && searchInput) {
                searchInput.value = searchTerm;
            }
            
            // Show no results message
            const existingNoResults = tbody.querySelector('.no-results-row');
            if (existingNoResults) {
                existingNoResults.remove();
            }
            
            if (visibleCount === 0 && query) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-row';
                noResultsRow.innerHTML = `
                    <td colspan="10" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium">لا توجد نتائج للبحث</p>
                            <p class="text-sm">جرب البحث بكلمات مختلفة</p>
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            }
        }

        // Table rendering functions
        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (appState.students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-user-graduate text-4xl mb-4 opacity-50"></i>
                                <p class="text-lg font-medium">لا توجد بيانات طلاب</p>
                                <p class="text-sm">ابدأ بإضافة طالب جديد</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appState.students.forEach(student => {
                const supervisor = appState.supervisors.find(s => s.id === student.supervisorId);
                const driver = appState.drivers.find(d => d.id === student.driverId);
                
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animation = 'fadeInUp 0.5s ease-out';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white font-medium">${student.aysisNumber || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                        <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${student.grade} - ${student.area}</div>
                        <div class="font-medium">${student.name}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${student.grade}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden md:table-cell">${student.area}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">${supervisor?.name || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">${driver?.name || '-'}</td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="viewStudent('${student.id}')" class="btn-action btn-view" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editStudent('${student.id}')" class="btn-action btn-edit" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStudent('${student.id}')" class="btn-action btn-delete" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSupervisorsTable() {
            const tbody = document.getElementById('supervisorsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (appState.supervisors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-user-tie text-4xl mb-4 opacity-50"></i>
                                <p class="text-lg font-medium">لا توجد بيانات مشرفات</p>
                                <p class="text-sm">ابدأ بإضافة مشرفة جديدة</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appState.supervisors.forEach(supervisor => {
                const isExpiring = supervisor.expiryDate && isExpiringWithin30Days(supervisor.expiryDate);
                
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animation = 'fadeInUp 0.5s ease-out';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white font-medium">${supervisor.permitNumber}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                        <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${supervisor.phone}</div>
                        <div class="font-medium">${supervisor.name}</div>
                        ${isExpiring ? '<div class="text-xs text-red-500">تصريح قارب على الانتهاء</div>' : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${supervisor.phone}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden md:table-cell">
                        ${supervisor.expiryDate ? `
                            <span class="${isExpiring ? 'text-red-600 font-semibold' : ''}">${supervisor.expiryDate}</span>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">${supervisor.area}</td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="viewSupervisor('${supervisor.id}')" class="btn-action btn-view" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editSupervisor('${supervisor.id}')" class="btn-action btn-edit" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSupervisor('${supervisor.id}')" class="btn-action btn-delete" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderDriversTable() {
            const tbody = document.getElementById('driversTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (appState.drivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-id-card text-4xl mb-4 opacity-50"></i>
                                <p class="text-lg font-medium">لا توجد بيانات سائقين</p>
                                <p class="text-sm">ابدأ بإضافة سائق جديد</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appState.drivers.forEach(driver => {
                const isExpiring = driver.expiryDate && isExpiringWithin30Days(driver.expiryDate);
                
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animation = 'fadeInUp 0.5s ease-out';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white font-medium">${driver.permitNumber}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                        <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${driver.phone}</div>
                        <div class="font-medium">${driver.name}</div>
                        ${isExpiring ? '<div class="text-xs text-red-500">تصريح قارب على الانتهاء</div>' : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${driver.phone}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden md:table-cell">${driver.area}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">
                        ${driver.expiryDate ? `
                            <span class="${isExpiring ? 'text-red-600 font-semibold' : ''}">${driver.expiryDate}</span>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="viewDriver('${driver.id}')" class="btn-action btn-view" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editDriver('${driver.id}')" class="btn-action btn-edit" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteDriver('${driver.id}')" class="btn-action btn-delete" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderBusesTable() {
            const tbody = document.getElementById('busesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (appState.buses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-bus text-4xl mb-4 opacity-50"></i>
                                <p class="text-lg font-medium">لا توجد بيانات حافلات</p>
                                <p class="text-sm">ابدأ بإضافة حافلة جديدة</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appState.buses.forEach(bus => {
                const isDotExpiring = bus.dotExpiryDate && isExpiringWithin30Days(bus.dotExpiryDate);
                const isOwnershipExpiring = bus.ownershipExpiryDate && isExpiringWithin30Days(bus.ownershipExpiryDate);
                
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animation = 'fadeInUp 0.5s ease-out';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white font-medium">${bus.number}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                        <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${bus.type}</div>
                        <div class="font-medium">${bus.company}</div>
                        ${(isDotExpiring || isOwnershipExpiring) ? '<div class="text-xs text-red-500">تصاريح قاربت على الانتهاء</div>' : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${bus.type}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden md:table-cell">${bus.dotNumber}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">
                        ${bus.dotExpiryDate ? `
                            <span class="${isDotExpiring ? 'text-red-600 font-semibold' : ''}">${bus.dotExpiryDate}</span>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">
                        ${bus.ownershipExpiryDate ? `
                            <span class="${isOwnershipExpiring ? 'text-red-600 font-semibold' : ''}">${bus.ownershipExpiryDate}</span>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="viewBus('${bus.id}')" class="btn-action btn-view" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editBus('${bus.id}')" class="btn-action btn-edit" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteBus('${bus.id}')" class="btn-action btn-delete" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderFuelTable() {
            const tbody = document.getElementById('fuelTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (appState.fuel.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-gas-pump text-4xl mb-4 opacity-50"></i>
                                <p class="text-lg font-medium">لا توجد بيانات ديزل</p>
                                <p class="text-sm">ابدأ بإضافة تعبئة جديدة</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appState.fuel.forEach(fuel => {
                const bus = appState.buses.find(b => b.id === fuel.busId);
                const driver = appState.drivers.find(d => d.id === fuel.driverId);
                
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animation = 'fadeInUp 0.5s ease-out';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white font-medium">${bus?.number || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${driver?.name || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                        <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${driver?.name || '-'}</div>
                        <div class="font-medium">${fuel.date}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white font-bold text-green-600">${fuel.amount} درهم</td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="viewFuel('${fuel.id}')" class="btn-action btn-view" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editFuel('${fuel.id}')" class="btn-action btn-edit" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteFuel('${fuel.id}')" class="btn-action btn-delete" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTopFuelConsumers() {
            const container = document.getElementById('topFuelConsumers');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Calculate fuel consumption by bus
            const consumption = {};
            appState.fuel.forEach(fuel => {
                const bus = appState.buses.find(b => b.id === fuel.busId);
                if (bus) {
                    if (!consumption[bus.number]) {
                        consumption[bus.number] = 0;
                    }
                    consumption[bus.number] += parseFloat(fuel.amount) || 0;
                }
            });
            
            // Sort and get top 3
            const sorted = Object.entries(consumption)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            if (sorted.length === 0) {
                container.innerHTML = `
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center col-span-3">
                        <p class="text-sm text-gray-500 dark:text-gray-400">لا توجد بيانات استهلاك</p>
                    </div>
                `;
                return;
            }
            
            sorted.forEach(([busNumber, amount], index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center';
                div.style.animation = 'fadeInUp 0.5s ease-out';
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-900 dark:text-white">حافلة ${busNumber}</span>
                        <span class="text-xs bg-primary text-white px-2 py-1 rounded-full">#${index + 1}</span>
                    </div>
                    <div class="text-xl font-bold text-primary">${amount.toFixed(2)} درهم</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">إجمالي الاستهلاك</div>
                `;
                container.appendChild(div);
            });
        }

        function renderMaintenanceTable() {
            const tbody = document.getElementById('maintenanceTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (appState.maintenance.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-tools text-4xl mb-4 opacity-50"></i>
                                <p class="text-lg font-medium">لا توجد بيانات صيانة</p>
                                <p class="text-sm">ابدأ بإضافة صيانة جديدة</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appState.maintenance.forEach(maintenance => {
                const bus = appState.buses.find(b => b.id === maintenance.busId);
                
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animation = 'fadeInUp 0.5s ease-out';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white font-medium">${maintenance.type}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                        <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">حافلة: ${bus?.number || '-'}</div>
                        <div class="font-medium">${maintenance.date}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${bus?.number || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden md:table-cell font-bold text-red-600">${maintenance.cost || '-'} درهم</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">${maintenance.description || '-'}</td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="viewMaintenance('${maintenance.id}')" class="btn-action btn-view" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editMaintenance('${maintenance.id}')" class="btn-action btn-edit" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMaintenance('${maintenance.id}')" class="btn-action btn-delete" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAttendanceTable() {
            const driversBody = document.getElementById('driversAttendanceBody');
            const supervisorsBody = document.getElementById('supervisorsAttendanceBody');
            
            if (!driversBody || !supervisorsBody) return;
            
            driversBody.innerHTML = '';
            supervisorsBody.innerHTML = '';
            
            // Filter attendance for today
            const today = new Date().toISOString().split('T')[0];
            
            // Drivers attendance
            const driversAttendance = appState.attendance.filter(a => a.type === 'driver' && a.date === today);
            if (driversAttendance.length === 0) {
                driversBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">
                            <p class="text-sm">لا توجد بيانات حضور اليوم</p>
                        </td>
                    </tr>
                `;
            } else {
                driversAttendance.forEach(attendance => {
                    const driver = appState.drivers.find(d => d.id === attendance.personId);
                    if (driver) {
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">
                                <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${attendance.time}</div>
                                <div class="font-medium">${driver.name}</div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${attendance.time}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="status-badge ${attendance.status === 'present' ? 'status-present' : 'status-absent'}">
                                    ${attendance.status === 'present' ? 'حاضر' : 'غائب'}
                                </span>
                            </td>
                        `;
                        driversBody.appendChild(row);
                    }
                });
            }
            
            // Supervisors attendance
            const supervisorsAttendance = appState.attendance.filter(a => a.type === 'supervisor' && a.date === today);
            if (supervisorsAttendance.length === 0) {
                supervisorsBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">
                            <p class="text-sm">لا توجد بيانات حضور اليوم</p>
                        </td>
                    </tr>
                `;
            } else {
                supervisorsAttendance.forEach(attendance => {
                    const supervisor = appState.supervisors.find(s => s.id === attendance.personId);
                    if (supervisor) {
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">
                                <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${attendance.time}</div>
                                <div class="font-medium">${supervisor.name}</div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${attendance.time}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="status-badge ${attendance.status === 'present' ? 'status-present' : 'status-absent'}">
                                    ${attendance.status === 'present' ? 'حاضر' : 'غائب'}
                                </span>
                            </td>
                        `;
                        supervisorsBody.appendChild(row);
                    }
                });
            }
        }

        function renderResignationsTable() {
            const tbody = document.getElementById('resignationsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (appState.resignations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-user-times text-4xl mb-4 opacity-50"></i>
                                <p class="text-lg font-medium">لا توجد بيانات استقالات أو إجازات</p>
                                <p class="text-sm">ابدأ بإضافة جديد</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appState.resignations.forEach(resignation => {
                let person = null;
                if (resignation.personType === 'driver') {
                    person = appState.drivers.find(d => d.id === resignation.personId);
                } else if (resignation.personType === 'supervisor') {
                    person = appState.supervisors.find(s => s.id === resignation.personId);
                }
                
                const statusText = {
                    'resignation': 'استقالة',
                    'termination': 'إنهاء خدمات',
                    'leave': 'إجازة'
                }[resignation.status] || resignation.status;

                const statusClass = {
                    'resignation': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                    'termination': 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200',
                    'leave': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
                }[resignation.status] || 'bg-gray-100 text-gray-800';
                
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animation = 'fadeInUp 0.5s ease-out';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                        <div class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mb-1">${resignation.personType === 'driver' ? 'سائق' : 'مشرفة'}</div>
                        <div class="font-medium">${person?.name || '-'}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden sm:table-cell">${resignation.personType === 'driver' ? 'سائق' : 'مشرفة'}</td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden md:table-cell">${resignation.date}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white hidden lg:table-cell">${resignation.reason || '-'}</td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="viewResignation('${resignation.id}')" class="btn-action btn-view" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editResignation('${resignation.id}')" class="btn-action btn-edit" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteResignation('${resignation.id}')" class="btn-action btn-delete" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Utility function to check if date is expiring within 30 days
        function isExpiringWithin30Days(dateString) {
            if (!dateString) return false;
            const date = new Date(dateString);
            const today = new Date();
            const daysLeft = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
            return daysLeft <= 30 && daysLeft >= 0;
        }

        // Form Functions - Part 1: Students
        function openStudentForm(studentId = null) {
            editingId = studentId;
            const student = studentId ? appState.students.find(s => s.id === studentId) : null;
            
            document.getElementById('modalTitle').textContent = studentId ? 'تعديل طالب' : 'إضافة طالب جديد';
            
            const supervisorOptions = appState.supervisors.map(s => 
                `<option value="${s.id}" ${student?.supervisorId === s.id ? 'selected' : ''}>${s.name}</option>`
            ).join('');
            
            const driverOptions = appState.drivers.map(d => 
                `<option value="${d.id}" ${student?.driverId === d.id ? 'selected' : ''}>${d.name}</option>`
            ).join('');
            
            document.getElementById('modalContent').innerHTML = `
                <form id="studentForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">رقم الاسيس <span class="text-red-500">*</span></label>
                        <input type="text" id="aysisNumber" value="${student?.aysisNumber || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">اسم الطالب <span class="text-red-500">*</span></label>
                        <input type="text" id="studentName" value="${student?.name || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الصف <span class="text-red-500">*</span></label>
                        <input type="text" id="grade" value="${student?.grade || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المنطقة <span class="text-red-500">*</span></label>
                        <input type="text" id="area" value="${student?.area || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المشرفة</label>
                        <select id="supervisorId" class="input-professional">
                            <option value="">اختر المشرفة</option>
                            ${supervisorOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">السائق</label>
                        <select id="driverId" class="input-professional">
                            <option value="">اختر السائق</option>
                            ${driverOptions}
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitStudentBtn" class="btn-professional">
                            <span id="submitText">${studentId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('studentForm').addEventListener('submit', handleStudentSubmit);
            showModal();
        }

        async function handleStudentSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitStudentBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                aysisNumber: document.getElementById('aysisNumber').value.trim(),
                name: document.getElementById('studentName').value.trim(),
                grade: document.getElementById('grade').value.trim(),
                area: document.getElementById('area').value.trim(),
                supervisorId: document.getElementById('supervisorId').value,
                driverId: document.getElementById('driverId').value
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('students', data);
                    const index = appState.students.findIndex(s => s.id === editingId);
                    appState.students[index] = data;
                    NotificationManager.show('تم تحديث الطالب بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('students', data);
                    data.id = newId;
                    appState.students.push(data);
                    NotificationManager.show('تم إضافة الطالب بنجاح', 'success');
                }
                
                closeModal();
                renderStudentsTable();
                updateDashboardStats();
            } catch (error) {
                console.error('Error saving student:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Form Functions - Part 2: Supervisors
        function openSupervisorForm(supervisorId = null) {
            editingId = supervisorId;
            const supervisor = supervisorId ? appState.supervisors.find(s => s.id === supervisorId) : null;
            
            document.getElementById('modalTitle').textContent = supervisorId ? 'تعديل مشرفة' : 'إضافة مشرفة جديدة';
            
            document.getElementById('modalContent').innerHTML = `
                <form id="supervisorForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">رقم التصريح <span class="text-red-500">*</span></label>
                        <input type="text" id="permitNumber" value="${supervisor?.permitNumber || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">اسم المشرفة <span class="text-red-500">*</span></label>
                        <input type="text" id="supervisorName" value="${supervisor?.name || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">رقم الهاتف <span class="text-red-500">*</span></label>
                        <input type="tel" id="phone" value="${supervisor?.phone || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ انتهاء التصريح</label>
                        <input type="date" id="expiryDate" value="${supervisor?.expiryDate || ''}" class="input-professional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">المنطقة <span class="text-red-500">*</span></label>
                        <input type="text" id="area" value="${supervisor?.area || ''}" class="input-professional" required>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitSupervisorBtn" class="btn-professional">
                            <span id="submitText">${supervisorId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('supervisorForm').addEventListener('submit', handleSupervisorSubmit);
            showModal();
        }

        async function handleSupervisorSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitSupervisorBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                permitNumber: document.getElementById('permitNumber').value.trim(),
                name: document.getElementById('supervisorName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                expiryDate: document.getElementById('expiryDate').value,
                area: document.getElementById('area').value.trim()
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('supervisors', data);
                    const index = appState.supervisors.findIndex(s => s.id === editingId);
                    appState.supervisors[index] = data;
                    NotificationManager.show('تم تحديث المشرفة بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('supervisors', data);
                    data.id = newId;
                    appState.supervisors.push(data);
                    NotificationManager.show('تم إضافة المشرفة بنجاح', 'success');
                }
                
                closeModal();
                renderSupervisorsTable();
                updateDashboardStats();
                updateDashboardSummary();
            } catch (error) {
                console.error('Error saving supervisor:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Form Functions - Part 3: Drivers
        function openDriverForm(driverId = null) {
            editingId = driverId;
            const driver = driverId ? appState.drivers.find(d => d.id === driverId) : null;
            
            document.getElementById('modalTitle').textContent = driverId ? 'تعديل سائق' : 'إضافة سائق جديد';
            
            document.getElementById('modalContent').innerHTML = `
                <form id="driverForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">رقم التصريح <span class="text-red-500">*</span></label>
                        <input type="text" id="permitNumber" value="${driver?.permitNumber || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">اسم السائق <span class="text-red-500">*</span></label>
                        <input type="text" id="driverName" value="${driver?.name || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">رقم الهاتف <span class="text-red-500">*</span></label>
                        <input type="tel" id="phone" value="${driver?.phone || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المنطقة <span class="text-red-500">*</span></label>
                        <input type="text" id="area" value="${driver?.area || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ انتهاء التصريح</label>
                        <input type="date" id="expiryDate" value="${driver?.expiryDate || ''}" class="input-professional">
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitDriverBtn" class="btn-professional">
                            <span id="submitText">${driverId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('driverForm').addEventListener('submit', handleDriverSubmit);
            showModal();
        }

        async function handleDriverSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitDriverBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                permitNumber: document.getElementById('permitNumber').value.trim(),
                name: document.getElementById('driverName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                area: document.getElementById('area').value.trim(),
                expiryDate: document.getElementById('expiryDate').value
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('drivers', data);
                    const index = appState.drivers.findIndex(d => d.id === editingId);
                    appState.drivers[index] = data;
                    NotificationManager.show('تم تحديث السائق بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('drivers', data);
                    data.id = newId;
                    appState.drivers.push(data);
                    NotificationManager.show('تم إضافة السائق بنجاح', 'success');
                }
                
                closeModal();
                renderDriversTable();
                updateDashboardStats();
                updateDashboardSummary();
            } catch (error) {
                console.error('Error saving driver:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Form Functions - Part 4: Buses
        function openBusForm(busId = null) {
            editingId = busId;
            const bus = busId ? appState.buses.find(b => b.id === busId) : null;
            
            document.getElementById('modalTitle').textContent = busId ? 'تعديل حافلة' : 'إضافة حافلة جديدة';
            
            document.getElementById('modalContent').innerHTML = `
                <form id="busForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">رقم الحافلة <span class="text-red-500">*</span></label>
                        <input type="text" id="busNumber" value="${bus?.number || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">اسم الشركة <span class="text-red-500">*</span></label>
                        <input type="text" id="company" value="${bus?.company || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">النوع <span class="text-red-500">*</span></label>
                        <select id="busType" class="input-professional" required>
                            <option value="">اختر النوع</option>
                            <option value="أشوك" ${bus?.type === 'أشوك' ? 'selected' : ''}>أشوك</option>
                            <option value="روزا" ${bus?.type === 'روزا' ? 'selected' : ''}>روزا</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">رقم DOT <span class="text-red-500">*</span></label>
                        <input type="text" id="dotNumber" value="${bus?.dotNumber || ''}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ انتهاء DOT</label>
                        <input type="date" id="dotExpiryDate" value="${bus?.dotExpiryDate || ''}" class="input-professional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ انتهاء الملكية</label>
                        <input type="date" id="ownershipExpiryDate" value="${bus?.ownershipExpiryDate || ''}" class="input-professional">
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitBusBtn" class="btn-professional">
                            <span id="submitText">${busId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('busForm').addEventListener('submit', handleBusSubmit);
            showModal();
        }

        async function handleBusSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitBusBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                number: document.getElementById('busNumber').value.trim(),
                company: document.getElementById('company').value.trim(),
                type: document.getElementById('busType').value,
                dotNumber: document.getElementById('dotNumber').value.trim(),
                dotExpiryDate: document.getElementById('dotExpiryDate').value,
                ownershipExpiryDate: document.getElementById('ownershipExpiryDate').value
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('buses', data);
                    const index = appState.buses.findIndex(b => b.id === editingId);
                    appState.buses[index] = data;
                    NotificationManager.show('تم تحديث الحافلة بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('buses', data);
                    data.id = newId;
                    appState.buses.push(data);
                    NotificationManager.show('تم إضافة الحافلة بنجاح', 'success');
                }
                
                closeModal();
                renderBusesTable();
                updateDashboardStats();
                updateDashboardSummary();
            } catch (error) {
                console.error('Error saving bus:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Form Functions - Part 5: Fuel
        function openFuelForm(fuelId = null) {
            editingId = fuelId;
            const fuel = fuelId ? appState.fuel.find(f => f.id === fuelId) : null;
            
            document.getElementById('modalTitle').textContent = fuelId ? 'تعديل تعبئة ديزل' : 'إضافة تعبئة ديزل جديدة';
            
            const busOptions = appState.buses.map(b => 
                `<option value="${b.id}" ${fuel?.busId === b.id ? 'selected' : ''}>${b.number} - ${b.company}</option>`
            ).join('');
            
            const driverOptions = appState.drivers.map(d => 
                `<option value="${d.id}" ${fuel?.driverId === d.id ? 'selected' : ''}>${d.name}</option>`
            ).join('');
            
            document.getElementById('modalContent').innerHTML = `
                <form id="fuelForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">الحافلة <span class="text-red-500">*</span></label>
                        <select id="busId" class="input-professional" required>
                            <option value="">اختر الحافلة</option>
                            ${busOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">السائق <span class="text-red-500">*</span></label>
                        <select id="driverId" class="input-professional" required>
                            <option value="">اختر السائق</option>
                            ${driverOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ التعبئة <span class="text-red-500">*</span></label>
                        <input type="date" id="fuelDate" value="${fuel?.date || new Date().toISOString().split('T')[0]}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المبلغ (درهم) <span class="text-red-500">*</span></label>
                        <input type="number" id="amount" value="${fuel?.amount || ''}" class="input-professional" min="0" step="0.01" required>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitFuelBtn" class="btn-professional">
                            <span id="submitText">${fuelId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('fuelForm').addEventListener('submit', handleFuelSubmit);
            showModal();
        }

        async function handleFuelSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitFuelBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                busId: document.getElementById('busId').value,
                driverId: document.getElementById('driverId').value,
                date: document.getElementById('fuelDate').value,
                amount: document.getElementById('amount').value
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('fuel', data);
                    const index = appState.fuel.findIndex(f => f.id === editingId);
                    appState.fuel[index] = data;
                    NotificationManager.show('تم تحديث تعبئة الديزل بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('fuel', data);
                    data.id = newId;
                    appState.fuel.push(data);
                    NotificationManager.show('تم إضافة تعبئة الديزل بنجاح', 'success');
                }
                
                closeModal();
                renderFuelTable();
                updateTopFuelConsumers();
                updateDashboardSummary();
            } catch (error) {
                console.error('Error saving fuel:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Form Functions - Part 6: Maintenance
        function openMaintenanceForm(maintenanceId = null) {
            editingId = maintenanceId;
            const maintenance = maintenanceId ? appState.maintenance.find(m => m.id === maintenanceId) : null;
            
            document.getElementById('modalTitle').textContent = maintenanceId ? 'تعديل صيانة' : 'إضافة صيانة جديدة';
            
            const busOptions = appState.buses.map(b => 
                `<option value="${b.id}" ${maintenance?.busId === b.id ? 'selected' : ''}>${b.number} - ${b.company}</option>`
            ).join('');
            
            document.getElementById('modalContent').innerHTML = `
                <form id="maintenanceForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">نوع الصيانة <span class="text-red-500">*</span></label>
                        <select id="maintenanceType" class="input-professional" required>
                            <option value="">اختر نوع الصيانة</option>
                            <option value="صيانة دورية" ${maintenance?.type === 'صيانة دورية' ? 'selected' : ''}>صيانة دورية</option>
                            <option value="إصلاح طارئ" ${maintenance?.type === 'إصلاح طارئ' ? 'selected' : ''}>إصلاح طارئ</option>
                            <option value="تغيير قطع غيار" ${maintenance?.type === 'تغيير قطع غيار' ? 'selected' : ''}>تغيير قطع غيار</option>
                            <option value="فحص دوري" ${maintenance?.type === 'فحص دوري' ? 'selected' : ''}>فحص دوري</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الحافلة <span class="text-red-500">*</span></label>
                        <select id="busId" class="input-professional" required>
                            <option value="">اختر الحافلة</option>
                            ${busOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ الصيانة <span class="text-red-500">*</span></label>
                        <input type="date" id="maintenanceDate" value="${maintenance?.date || new Date().toISOString().split('T')[0]}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">التكلفة (درهم)</label>
                        <input type="number" id="cost" value="${maintenance?.cost || ''}" class="input-professional" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">وصف الصيانة</label>
                        <textarea id="description" rows="3" class="input-professional" placeholder="اكتب وصف الصيانة...">${maintenance?.description || ''}</textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitMaintenanceBtn" class="btn-professional">
                            <span id="submitText">${maintenanceId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('maintenanceForm').addEventListener('submit', handleMaintenanceSubmit);
            showModal();
        }

        async function handleMaintenanceSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitMaintenanceBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                type: document.getElementById('maintenanceType').value,
                busId: document.getElementById('busId').value,
                date: document.getElementById('maintenanceDate').value,
                cost: document.getElementById('cost').value,
                description: document.getElementById('description').value.trim()
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('maintenance', data);
                    const index = appState.maintenance.findIndex(m => m.id === editingId);
                    appState.maintenance[index] = data;
                    NotificationManager.show('تم تحديث الصيانة بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('maintenance', data);
                    data.id = newId;
                    appState.maintenance.push(data);
                    NotificationManager.show('تم إضافة الصيانة بنجاح', 'success');
                }
                
                closeModal();
                renderMaintenanceTable();
                updateDashboardSummary();
            } catch (error) {
                console.error('Error saving maintenance:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Form Functions - Part 7: Attendance
        function openAttendanceForm(attendanceId = null) {
            editingId = attendanceId;
            const attendance = attendanceId ? appState.attendance.find(a => a.id === attendanceId) : null;
            
            document.getElementById('modalTitle').textContent = attendanceId ? 'تعديل حضور' : 'تسجيل حضور جديد';
            
            document.getElementById('modalContent').innerHTML = `
                <form id="attendanceForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">النوع <span class="text-red-500">*</span></label>
                        <select id="attendanceType" class="input-professional" required onchange="updatePersonOptions()">
                            <option value="">اختر النوع</option>
                            <option value="driver" ${attendance?.type === 'driver' ? 'selected' : ''}>سائق</option>
                            <option value="supervisor" ${attendance?.type === 'supervisor' ? 'selected' : ''}>مشرفة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الشخص <span class="text-red-500">*</span></label>
                        <select id="personId" class="input-professional" required>
                            <option value="">اختر الشخص</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">التاريخ <span class="text-red-500">*</span></label>
                        <input type="date" id="attendanceDate" value="${attendance?.date || new Date().toISOString().split('T')[0]}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الوقت <span class="text-red-500">*</span></label>
                        <input type="time" id="attendanceTime" value="${attendance?.time || '07:00'}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الحالة <span class="text-red-500">*</span></label>
                        <select id="attendanceStatus" class="input-professional" required>
                            <option value="">اختر الحالة</option>
                            <option value="present" ${attendance?.status === 'present' ? 'selected' : ''}>حاضر</option>
                            <option value="absent" ${attendance?.status === 'absent' ? 'selected' : ''}>غائب</option>
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitAttendanceBtn" class="btn-professional">
                            <span id="submitText">${attendanceId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            // Initialize person options if editing
            if (attendance) {
                setTimeout(() => {
                    updatePersonOptions();
                    document.getElementById('personId').value = attendance.personId;
                }, 100);
            }
            
            document.getElementById('attendanceForm').addEventListener('submit', handleAttendanceSubmit);
            showModal();
        }

        function updatePersonOptions() {
            const typeSelect = document.getElementById('attendanceType');
            const personSelect = document.getElementById('personId');
            
            if (!typeSelect || !personSelect) return;
            
            const type = typeSelect.value;
            personSelect.innerHTML = '<option value="">اختر الشخص</option>';
            
            if (type === 'driver') {
                appState.drivers.forEach(driver => {
                    personSelect.innerHTML += `<option value="${driver.id}">${driver.name}</option>`;
                });
            } else if (type === 'supervisor') {
                appState.supervisors.forEach(supervisor => {
                    personSelect.innerHTML += `<option value="${supervisor.id}">${supervisor.name}</option>`;
                });
            }
        }

        async function handleAttendanceSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitAttendanceBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                type: document.getElementById('attendanceType').value,
                personId: document.getElementById('personId').value,
                date: document.getElementById('attendanceDate').value,
                time: document.getElementById('attendanceTime').value,
                status: document.getElementById('attendanceStatus').value
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('attendance', data);
                    const index = appState.attendance.findIndex(a => a.id === editingId);
                    appState.attendance[index] = data;
                    NotificationManager.show('تم تحديث الحضور بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('attendance', data);
                    data.id = newId;
                    appState.attendance.push(data);
                    NotificationManager.show('تم تسجيل الحضور بنجاح', 'success');
                }
                
                closeModal();
                renderAttendanceTable();
            } catch (error) {
                console.error('Error saving attendance:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Form Functions - Part 8: Resignations
        function openResignationForm(resignationId = null) {
            editingId = resignationId;
            const resignation = resignationId ? appState.resignations.find(r => r.id === resignationId) : null;
            
            document.getElementById('modalTitle').textContent = resignationId ? 'تعديل استقالة/إجازة' : 'إضافة استقالة/إجازة جديدة';
            
            document.getElementById('modalContent').innerHTML = `
                <form id="resignationForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">نوع الشخص <span class="text-red-500">*</span></label>
                        <select id="resignationPersonType" class="input-professional" required onchange="updateResignationPersonOptions()">
                            <option value="">اختر نوع الشخص</option>
                            <option value="driver" ${resignation?.personType === 'driver' ? 'selected' : ''}>سائق</option>
                            <option value="supervisor" ${resignation?.personType === 'supervisor' ? 'selected' : ''}>مشرفة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الشخص <span class="text-red-500">*</span></label>
                        <select id="resignationPersonId" class="input-professional" required>
                            <option value="">اختر الشخص</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الحالة <span class="text-red-500">*</span></label>
                        <select id="resignationStatus" class="input-professional" required>
                            <option value="">اختر الحالة</option>
                            <option value="resignation" ${resignation?.status === 'resignation' ? 'selected' : ''}>استقالة</option>
                            <option value="termination" ${resignation?.status === 'termination' ? 'selected' : ''}>إنهاء خدمات</option>
                            <option value="leave" ${resignation?.status === 'leave' ? 'selected' : ''}>إجازة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">التاريخ <span class="text-red-500">*</span></label>
                        <input type="date" id="resignationDate" value="${resignation?.date || new Date().toISOString().split('T')[0]}" class="input-professional" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">السبب</label>
                        <textarea id="resignationReason" rows="3" class="input-professional" placeholder="اكتب السبب...">${resignation?.reason || ''}</textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                        <button type="submit" id="submitResignationBtn" class="btn-professional">
                            <span id="submitText">${resignationId ? 'تحديث' : 'إضافة'}</span>
                            <span id="submitLoading" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </form>
            `;
            
            // Initialize person options if editing
            if (resignation) {
                setTimeout(() => {
                    updateResignationPersonOptions();
                    document.getElementById('resignationPersonId').value = resignation.personId;
                }, 100);
            }
            
            document.getElementById('resignationForm').addEventListener('submit', handleResignationSubmit);
            showModal();
        }

        function updateResignationPersonOptions() {
            const typeSelect = document.getElementById('resignationPersonType');
            const personSelect = document.getElementById('resignationPersonId');
            
            if (!typeSelect || !personSelect) return;
            
            const type = typeSelect.value;
            personSelect.innerHTML = '<option value="">اختر الشخص</option>';
            
            if (type === 'driver') {
                appState.drivers.forEach(driver => {
                    personSelect.innerHTML += `<option value="${driver.id}">${driver.name}</option>`;
                });
            } else if (type === 'supervisor') {
                appState.supervisors.forEach(supervisor => {
                    personSelect.innerHTML += `<option value="${supervisor.id}">${supervisor.name}</option>`;
                });
            }
        }

        async function handleResignationSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const submitBtn = document.getElementById('submitResignationBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            isSubmitting = true;
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const data = {
                personType: document.getElementById('resignationPersonType').value,
                personId: document.getElementById('resignationPersonId').value,
                status: document.getElementById('resignationStatus').value,
                date: document.getElementById('resignationDate').value,
                reason: document.getElementById('resignationReason').value.trim()
            };
            
            try {
                if (editingId) {
                    data.id = editingId;
                    await DatabaseManager.saveData('resignations', data);
                    const index = appState.resignations.findIndex(r => r.id === editingId);
                    appState.resignations[index] = data;
                    NotificationManager.show('تم تحديث البيانات بنجاح', 'success');
                } else {
                    const newId = await DatabaseManager.saveData('resignations', data);
                    data.id = newId;
                    appState.resignations.push(data);
                    NotificationManager.show('تم إضافة البيانات بنجاح', 'success');
                }
                
                closeModal();
                renderResignationsTable();
            } catch (error) {
                console.error('Error saving resignation:', error);
                NotificationManager.show('حدث خطأ أثناء حفظ البيانات', 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // View functions
        function viewStudent(id) { openStudentForm(id); }
        function viewSupervisor(id) { openSupervisorForm(id); }
        function viewDriver(id) { openDriverForm(id); }
        function viewBus(id) { openBusForm(id); }
        function viewFuel(id) { openFuelForm(id); }
        function viewMaintenance(id) { openMaintenanceForm(id); }
        function viewAttendance(id) { openAttendanceForm(id); }
        function viewResignation(id) { openResignationForm(id); }

        // Edit functions
        function editStudent(id) { openStudentForm(id); }
        function editSupervisor(id) { openSupervisorForm(id); }
        function editDriver(id) { openDriverForm(id); }
        function editBus(id) { openBusForm(id); }
        function editFuel(id) { openFuelForm(id); }
        function editMaintenance(id) { openMaintenanceForm(id); }
        function editAttendance(id) { openAttendanceForm(id); }
        function editResignation(id) { openResignationForm(id); }

        // Delete functions with improved confirmations
        async function deleteStudent(id) {
            const student = appState.students.find(s => s.id === id);
            if (!student) return;

            showConfirmDialog(`هل أنت متأكد من حذف الطالب "${student.name}"؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('students', id);
                    appState.students = appState.students.filter(s => s.id !== id);
                    renderStudentsTable();
                    updateDashboardStats();
                    NotificationManager.show(`تم حذف الطالب "${student.name}" بنجاح`, 'success');
                } catch (error) {
                    console.error('Error deleting student:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function deleteSupervisor(id) {
            const supervisor = appState.supervisors.find(s => s.id === id);
            if (!supervisor) return;

            showConfirmDialog(`هل أنت متأكد من حذف المشرفة "${supervisor.name}"؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('supervisors', id);
                    appState.supervisors = appState.supervisors.filter(s => s.id !== id);
                    renderSupervisorsTable();
                    updateDashboardStats();
                    updateDashboardSummary();
                    NotificationManager.show(`تم حذف المشرفة "${supervisor.name}" بنجاح`, 'success');
                } catch (error) {
                    console.error('Error deleting supervisor:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function deleteDriver(id) {
            const driver = appState.drivers.find(d => d.id === id);
            if (!driver) return;

            showConfirmDialog(`هل أنت متأكد من حذف السائق "${driver.name}"؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('drivers', id);
                    appState.drivers = appState.drivers.filter(d => d.id !== id);
                    renderDriversTable();
                    updateDashboardStats();
                    updateDashboardSummary();
                    NotificationManager.show(`تم حذف السائق "${driver.name}" بنجاح`, 'success');
                } catch (error) {
                    console.error('Error deleting driver:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function deleteBus(id) {
            const bus = appState.buses.find(b => b.id === id);
            if (!bus) return;

            showConfirmDialog(`هل أنت متأكد من حذف الحافلة رقم "${bus.number}"؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('buses', id);
                    appState.buses = appState.buses.filter(b => b.id !== id);
                    renderBusesTable();
                    updateDashboardStats();
                    updateDashboardSummary();
                    NotificationManager.show(`تم حذف الحافلة رقم "${bus.number}" بنجاح`, 'success');
                } catch (error) {
                    console.error('Error deleting bus:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function deleteFuel(id) {
            const fuel = appState.fuel.find(f => f.id === id);
            if (!fuel) return;

            showConfirmDialog(`هل أنت متأكد من حذف سجل الديزل؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('fuel', id);
                    appState.fuel = appState.fuel.filter(f => f.id !== id);
                    renderFuelTable();
                    updateTopFuelConsumers();
                    updateDashboardSummary();
                    NotificationManager.show('تم حذف سجل الديزل بنجاح', 'success');
                } catch (error) {
                    console.error('Error deleting fuel:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function deleteMaintenance(id) {
            const maintenance = appState.maintenance.find(m => m.id === id);
            if (!maintenance) return;

            showConfirmDialog(`هل أنت متأكد من حذف سجل الصيانة؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('maintenance', id);
                    appState.maintenance = appState.maintenance.filter(m => m.id !== id);
                    renderMaintenanceTable();
                    updateDashboardSummary();
                    NotificationManager.show('تم حذف سجل الصيانة بنجاح', 'success');
                } catch (error) {
                    console.error('Error deleting maintenance:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function deleteAttendance(id) {
            const attendance = appState.attendance.find(a => a.id === id);
            if (!attendance) return;

            showConfirmDialog(`هل أنت متأكد من حذف سجل الحضور؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('attendance', id);
                    appState.attendance = appState.attendance.filter(a => a.id !== id);
                    renderAttendanceTable();
                    NotificationManager.show('تم حذف سجل الحضور بنجاح', 'success');
                } catch (error) {
                    console.error('Error deleting attendance:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function deleteResignation(id) {
            const resignation = appState.resignations.find(r => r.id === id);
            if (!resignation) return;

            showConfirmDialog(`هل أنت متأكد من حذف هذا السجل؟<br>هذا الإجراء لا يمكن التراجع عنه.`, async function() {
                showLoading();
                try {
                    await DatabaseManager.deleteData('resignations', id);
                    appState.resignations = appState.resignations.filter(r => r.id !== id);
                    renderResignationsTable();
                    NotificationManager.show('تم حذف السجل بنجاح', 'success');
                } catch (error) {
                    console.error('Error deleting resignation:', error);
                    NotificationManager.show('حدث خطأ أثناء الحذف', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        // Import/Export functions
        function importExcel(section, input) {
            const file = input.files[0];
            if (!file) return;

            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    // Process imported data based on section
                    processImportedData(section, jsonData);
                    
                    NotificationManager.show(`تم استيراد ${jsonData.length} عنصر بنجاح`, 'success');
                } catch (error) {
                    console.error('Error importing file:', error);
                    NotificationManager.show('حدث خطأ أثناء استيراد الملف', 'error');
                } finally {
                    hideLoading();
                    input.value = ''; // Reset input
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        async function processImportedData(section, data) {
            // This is a simplified import process
            // In a real application, you would need proper validation and mapping
            for (const item of data) {
                try {
                    const newId = await DatabaseManager.saveData(section, item);
                    item.id = newId;
                    appState[section].push(item);
                } catch (error) {
                    console.error(`Error saving imported item:`, error);
                }
            }
            
            // Refresh the current section's table
            loadSectionData(currentSection);
            updateDashboardStats();
        }

        function exportToExcel(section) {
            try {
                const data = appState[section];
                
                if (!data || data.length === 0) {
                    NotificationManager.show('لا توجد بيانات للتصدير', 'warning');
                    return;
                }

                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // Convert data to worksheet
                const ws = XLSX.utils.json_to_sheet(data);
                
                // Add the worksheet to the workbook
                XLSX.utils.book_append_sheet(wb, ws, section);
                
                // Generate file name with current date
                const date = new Date().toISOString().split('T')[0];
                const fileName = `${section}_${date}.xlsx`;
                
                // Save the file
                XLSX.writeFile(wb, fileName);
                
                NotificationManager.show(`تم تصدير ${data.length} عنصر بنجاح`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                NotificationManager.show('حدث خطأ أثناء التصدير', 'error');
            }
        }

        // Modal functions
        function showModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
            document.body.style.overflow = '';
            editingId = null;
            isSubmitting = false;
        }

        // Make functions available globally
        window.showSection = showSection;
        window.openStudentForm = openStudentForm;
        window.openSupervisorForm = openSupervisorForm;
        window.openDriverForm = openDriverForm;
        window.openBusForm = openBusForm;
        window.openFuelForm = openFuelForm;
        window.openMaintenanceForm = openMaintenanceForm;
        window.openAttendanceForm = openAttendanceForm;
        window.openResignationForm = openResignationForm;
        window.exportToExcel = exportToExcel;
        window.importExcel = importExcel;
        window.filterTable = filterTable;
        window.performGlobalSearch = performGlobalSearch;
        window.updatePersonOptions = updatePersonOptions;
        window.updateResignationPersonOptions = updateResignationPersonOptions;
        window.closeModal = closeModal;
        window.viewStudent = viewStudent;
        window.editStudent = editStudent;
        window.deleteStudent = deleteStudent;
        window.viewSupervisor = viewSupervisor;
        window.editSupervisor = editSupervisor;
        window.deleteSupervisor = deleteSupervisor;
        window.viewDriver = viewDriver;
        window.editDriver = editDriver;
        window.deleteDriver = deleteDriver;
        window.viewBus = viewBus;
        window.editBus = editBus;
        window.deleteBus = deleteBus;
        window.viewFuel = viewFuel;
        window.editFuel = editFuel;
        window.deleteFuel = deleteFuel;
        window.viewMaintenance = viewMaintenance;
        window.editMaintenance = editMaintenance;
        window.deleteMaintenance = deleteMaintenance;
        window.viewAttendance = viewAttendance;
        window.editAttendance = editAttendance;
        window.deleteAttendance = deleteAttendance;
        window.viewResignation = viewResignation;
        window.editResignation = editResignation;
        window.deleteResignation = deleteResignation;
    </script>
</body>
</html>
